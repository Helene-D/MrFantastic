<!-- Import bower_components -->
<link rel="import" href="../../bower_components/font-roboto/roboto.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">

<!-- Firebase elements-->
<link rel="import" href="/bower_components/firebase-element/firebase-element.html">
<link rel="import" href="/bower_components/firebase-element/firebase-login.html">

<!-- PVC Globals element -->
<link rel="import" href="/bower_components/pvc-globals/pvc-globals.html">

<!-- Import custom components -->
<link rel="import" href="../search-engine/search-engine.html">

<polymer-element name="fantastic-app" attributes="">
  <template>
    <pvc-globals values="{{ globals }}"></pvc-globals>
    <firebase-element id="base" on-data-change="{{dataChange}}" data="{{data}}" location="https://fantastic.firebaseio.com/user/{{urlUid}}" log></firebase-element>
    <firebase-login id="baseLogin" user="{{user}}" statusKnown="{{statusKnown}}" location="https://fantastic.firebaseio.com/user" provider="google" on-login="{{onLogin}}" on-error="{{onLoginError}}"></firebase-login>

    <!-- Navigation bar -->
    <core-toolbar class="medium-tall animate">
      <div id="logo" flex>
        MrFantastic
      </div>
      <div>
        <paper-button on-click="{{ logout }}">Logout</paper-button>
      </div>

      <!-- Navigation tabs -->
      <div class="bottom fit" horizontal layout >
        <paper-tabs selected="0" flex id="navigation">
          <paper-tab>Browse</paper-tab>
          <paper-tab>Collection</paper-tab>
          <paper-tab>Wishlist</paper-tab>
        </paper-tabs>
        <!-- <user-account></user-account> -->
      </div>
    </core-toolbar>

    <core-animated-pages transitions="slide-from-right" id="slides">

      <!-- Browse page -->
      <div id="browse">
        <search-engine id="search"></search-engine>
      </div>

      <!-- Collection page -->
      <div id="collection">
        <!-- <h3>Oops ! Your collection is empty, let's <a href="#" on-click="{{ goBrowse }}">browse</a> in order to add some comics !</h3> -->
        <ul layout vertical>
          <template repeat="{{ comic, i in collection }}">
            <li>
              <div class="comicHead" on-click="{{ toggle }}">
                <img src="{{ comic.image.super_url }}" alt="{{ comic.name }}" class="comicBg">
                <div horizontal layout>
                  <div>
                    <h4 style="text-transform: uppercase">{{ comic.name }}</h4>
                  </div>
                  <div flex>
                    <h4>{{ comic.publisher.name }}</h4>
                  </div>
                  <div>
                    <h4>{{ comic.start_year }}</h4>
                  </div>
                </div>
              </div>
              <core-collapse id="collapse{{i}}">
                <ul layout vertical>
                  <template repeat="{{ issue, i in comic.issues }}">
                    <li layout horizontal on-click="{{ labelChecked }}">
                      <div flex horizontal layout>
                        <paper-checkbox label="#{{ comic.starting_issue + i }}" checked="{{ issue }}" flex></paper-checkbox>
                      </div>
                    </li>
                  </template>
                </ul>
              </core-collapse>
            </li>
          </template>
        </ul>
      </div>

      <!-- Wishlist page -->
      <div id="wishlist">
        <ul layout vertical>
          <template repeat="{{ w in wishlist }}">
            <li layout horizontal>
              <div flex>{{ w.name }}</div>
              <div>{{ w.start_year }}</div>
            </li>
          </template>
        </ul>
      </div>

    </core-animated-pages>

    <!-- Notifications -->
    <paper-toast id="success" class="capsule" text="Success !"></paper-toast>
    <paper-toast id="error" role="alert" text="Error..."></paper-toast>
  </template>
  <script>
    (function() {

      Polymer('fantastic-app',{

        ready: function() {
          this.collection = this.$.search.$.comic.collection
          this.wishlist = this.$.search.$.comic.wishlist

          // Link between paper-tabs & core-animated-pages
          var tabs = this.$.navigation
          var pages = this.$.slides
          tabs.addEventListener('core-select', function () {
            pages.selected = tabs.selected;
          });

          this.uid = this.globals.currentUser.uid
          // Change ":" in uid for "%3A" to match with the url
          this.urlUid = this.uid.replace(/:/, "%3A")
        },

        goBrowse: function() {
          var pages = this.$.slides
          var tabs = this.$.navigation
          pages.selected = 0;
          tabs.selected = 0;
        },

        labelChecked: function(e, detail, sender) {

          //console.log(this.collection)

          //Index of comic in collection
          //TODO: find it
          //console.log(e.target.templateInstance)

          //Number of issue
          //console.log(e.target.templateInstance.model.i)

          //State
          //console.log(e.target.templateInstance.model.issue)

          //Firebase
          var ref = new Firebase(this.$.base.location);
          var myUid = this.globals.currentUser.uid;
          ref.child("collection").set(this.collection);
        },

        toggle: function(e, detail, sender) {
          this.querySelector('fantastic-app::shadow #collapse' + e.target.templateInstance.model.i).toggle();
        },

        logout: function() {
          this.$.baseLogin.logout();
        }

      });

    })();
  </script>
