<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-media-query/core-media-query.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">

<!-- Firebase element-->
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">

<!-- PVC Globals element -->
<link rel="import" href="../../bower_components/pvc-globals/pvc-globals.html">

<polymer-element name="comicvine-api" attributes="method query limit page numberResults resources">
  <template>

    <firebase-element id="base" on-data-change="{{dataChange}}" data="{{data}}" location="https://fantastic.firebaseio.com/user/{{urlUid}}" log></firebase-element>
    <pvc-globals values="{{ globals }}" id="globals"></pvc-globals>

    <core-ajax
      auto
      url="//jsonp.nodejitsu.com/"
      handleAs="{{format}}"
      on-core-response="{{ajaxResponse}}"
      params='{ "url" : "http://www.comicvine.com/api/{{method}}/?api_key={{api_key}}&limit={{limit}}&format={{format}}&query={{query}}&page=&resources={{resources}}" }'>
    </core-ajax>
    <template if="{{hasResults && !init}}">
      <core-media-query query="max-width: 768px" queryMatches="{{phoneScreen}}"></core-media-query>
      <div class="container">
        <h3 style="margin-left: 10px;">{{displayedResults}} of {{numResults}} Results</h3>
        <ul layout vertical?="{{phoneScreen}}" horizontal?="{{!phoneScreen}}" wrap?="{{!phoneScreen}}">
          <template repeat="{{ r in results }}" id="comicGenerator">
            <li layout horizontal flex?="{{!phoneScreen}}" class="comic">
              <div>
                <img src="{{ r.image.screen_url }}" alt="{{ r.name }}">
              </div>
              <div class="infos" flex>
                <h2 id="comicName">{{r.name}}</h2>
                <p>{{r.start_year}}</p>
                <p>{{r.publisher.name}}</p>
              </div>
              <paper-icon-button id="addWishlist" icon="favorite" on-click="{{addToWishlist}}"></paper-icon-button>

                <paper-fab id="addCollection" icon="add" on-click="{{ addToCollection }}" class="comic{{ r.id }}"></paper-fab>
              <<!-- template if="{{isInCollection == true}}">
                <paper-fab id="addCollection" icon="clear" on-click="{{ addToCollection }}" class="comic{{ r.id }}"></paper-fab>
              </template>
              <template if="{{isInCollection == false}}">
              </template> -->

            </li>
          </template>
        </ul>
      </div>
    </template>
    <template if="{{!hasResults && !init}}">
      <h3>Nothing found</h3>
    </template>
  </template>
  <script>
  (function() {

    var collection = [];
    var wishlist = [];

    Polymer('comicvine-api',{

      ajaxResponse: function(event, response) {

        this.results = response.response.results;
        this.numResults = response.response.number_of_total_results;
        this.hasResults = false;

        // turn off Initialization
        if (this.numResults != 0) {
          this.init = false;
          this.hasResults = true;
          if( this.numResults < this.limit ) {
            this.displayedResults = this.numResults;
          } else {
            this.displayedResults = this.limit
          }
        }

        // // Trying to handle button if it is in database
        // if (this.query && this.displayedResults) {
        //   for ( id in this.data.collection ) {
        //     console.log(document.querySelector('html /deep/ paper-fab.comic'+id))
        //     if (document.querySelector('html /deep/ paper-fab.comic'+id)) {
        //       document.querySelector('html /deep/ paper-fab.comic'+id).setAttribute('icon', 'clear')
        //     };
        //   }
        // };


      },

      isInCollection: function(event, detail, sender) {
        // Trying to handle button if it is in database
        // if (this.query && this.displayedResults) {
        //   for ( id in this.data.collection ) {
        //     console.log(document.querySelector('html /deep/ paper-fab.comic'+id))
        //     if (document.querySelector('html /deep/ paper-fab.comic'+id)) {
        //       return false;
        //     } else {
        //       return true;
        //     };
        //   }
        // };
      },

      dataChange: function() {
        //console.log(Object.keys(this.data.collection).length)
        if (this.query && this.displayedResults) {
          for ( id in this.data.collection ) {
            //console.log(document.querySelector('html /deep/ paper-fab.comic'+id))
            if (document.querySelector('html /deep/ paper-fab.comic'+id)) {
              document.querySelector('html /deep/ paper-fab.comic'+id).setAttribute('icon', 'clear')
            } 
            //else {
            //   document.querySelector('html /deep/ paper-fab.comic'+id).setAttribute('icon', 'add')
            // };
          }
        }
      },

      ready: function() {

        // Initialization
        this.init = true;
        this.api_key = '6141777d4e164896d16ca909cd5ed0b1c867f4f8';
        this.format = 'json';
        this.collection = collection;
        this.collectionLength = this.collection.length;
        this.wishlist = wishlist;

        this.uid = this.globals.currentUser.uid
        // Change ":" in uid for "%3A" to match with the url
        this.urlUid = this.uid.replace(/:/, '%3A')
        this.collection = this.data
      },

      addToCollection: function(e, detail, sender) {

        var comic = e.target.templateInstance.model.r;

        var refOne = new Firebase('https://fantastic.firebaseio.com/comics');
        var refTwo = new Firebase(this.$.base.location+'/collection');
        
        function comicIsInCollectionCallback(exists) {
          if (exists) {

            // Remove from collection
            refTwo.child(comic.id).remove();

            // TODO:
            // Modify icon
            e.target.setAttribute('icon', 'add');

            // Modify and show toast (notification)
            toast_element = document.querySelector('fantastic-app::shadow #success');
            toast_element.text = 'Deleted '+ comic.name +' from your collection';
            toast_element.show();

          } else {
            
            // Pushing all issues in the comic 
            var firstIssueString = comic.first_issue.issue_number;

            var firstIssue = parseInt(firstIssueString, 10);
            comic.starting_issue = firstIssue;

            for( i = comic.starting_issue ; i <= comic.count_of_issues ; i++ ) {
              refTwo.child(comic.id).child(i).set(false);
            };

            // TODO:
            // Modify icon
            e.target.setAttribute('icon', 'clear');
            
            // Modify and show toast (notification)
            toast_element = document.querySelector('fantastic-app::shadow #success');
            toast_element.text = 'Added '+ comic.name +' to your collection !';
            toast_element.show();

          }
        }

        refTwo.child(comic.id).once('value', function(snapshot) {
          var exists = (snapshot.val() !== null || undefined);
          comicIsInCollectionCallback(exists);
        });

      },

      // addToWishlist: function(e, detail, sender) {

      //   var comic = e.target.templateInstance.model.r;

      //   // If this object is not in wishlist
      //   if (this.wishlist.indexOf(comic) == -1) {

      //     // Push into wishlist
      //     this.wishlist.push(comic);

      //     // Modify and show toast (notification)
      //     toast_element = document.querySelector('fantastic-app::shadow #success');
      //     toast_element.text = 'Added '+ comic.name +' to your wishlist !';
      //     toast_element.show();

      //     // Change icon color
      //     e.target.setAttribute("class", "active")

      //   }
      //   else {

      //     // If this object is in wishlist
      //     if (this.wishlist.indexOf(comic) > -1) {

      //       // Remove from wishlist
      //       this.wishlist.splice(this.wishlist.indexOf(comic));

      //       // Modify and show toast (notification)
      //       toast_element = document.querySelector('fantastic-app::shadow #success');
      //       toast_element.text = 'Deleted '+ comic.name +' from your wishlist';
      //       toast_element.show();

      //       // Change icon color
      //       e.target.setAttribute("class", "inactive")
      //     }
      //     else {

      //       // Show error notification message
      //       toast_element = document.querySelector('fantastic-app::shadow #error');
      //       toast_element.text = 'You haven\'t '+ comic.name +' in your wishlist...';
      //       toast_element.show();

      //     }
      //   }
      // }

    });
  })();

  </script>
</polymer-element>
