<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-media-query/core-media-query.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">

<polymer-element name="comicvine-api" attributes="method query limit page numberResults resources">
  <template>
    
    <style>
      core-tooltip.fancy::shadow .polymer-tooltip {
        opacity: 0;
        -webkit-transition: all 300ms cubic-bezier(0,1.92,.99,1.07);
        transition: all 300ms cubic-bezier(0,1.92,.99,1.07);
        -webkit-transform: translate3d(0, -10px, 0);
        transform: translate3d(0, -10px, 0);
      }

      core-tooltip.fancy:hover::shadow .polymer-tooltip,
      core-tooltip.fancy:focus::shadow .polymer-tooltip {
        opacity: 1;
        -webkit-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
      }
    </style>

    <core-ajax 
      auto 
      url="//jsonp.nodejitsu.com/" 
      handleAs="{{format}}" 
      on-core-response="{{ajaxResponse}}" 
      params='{ "url" : "http://www.comicvine.com/api/{{method}}/?api_key={{api_key}}&limit={{limit}}&format={{format}}&query={{query}}&page=&resources={{resources}}" }'>
    </core-ajax>

    <template if="{{hasResults && !init}}">
      <core-media-query query="max-width: 768px" queryMatches="{{phoneScreen}}"></core-media-query>
      <div class="container">
        <h3 style="margin-left: 10px;">{{numResults}} Results</h3>
        <ul layout vertical?="{{phoneScreen}}" horizontal?="{{!phoneScreen}}" wrap?="{{!phoneScreen}}">
          <template repeat="{{ r in results }}">
            <li layout horizontal flex?="{{!phoneScreen}}" class="comic">
              <div>
                <img src="{{ r.image.super_url }}" alt="{{r.name}}">
              </div>
              <div class="infos" flex>
                <h2 id="comicName">{{r.name}}</h2>
                <p>{{r.start_year}}</p>
                <p>{{r.publisher.name}}</p>
              </div>
              <paper-icon-button id="addWishlist" icon="favorite" on-click="{{addToWishlist}}"></paper-icon-button>
              <paper-fab id="addCollection" icon="add" on-click="{{addToCollection}}"></paper-fab>
            </li>
          </template>
        </ul>
      </div>
    </template>
    <template if="{{!hasResults && !init}}">
      <h3>Nothing found</h3>
    </template>
  </template>
  <script>
  (function() {
    var collection = [];
    var wishlist = [];

    Polymer('comicvine-api',{
      ajaxResponse: function(event, response) {
        this.results = response.response.results;
        this.numResults = response.response.number_of_total_results;
        this.hasResults = false;
        // turn off Initialization
        if (this.numResults != 0) {
          this.init = false;
          this.hasResults = true;
          this.icon = "add";
        }
      },
      ready: function() {
        // Initialization
        this.init = true;
        this.api_key = "6141777d4e164896d16ca909cd5ed0b1c867f4f8";
        this.format = "json";
        this.collection = collection;
        this.wishlist = wishlist;
      },
      addToCollection: function(e, detail, sender) {
        var comic = e.target.templateInstance.model.r;

        // If this object is not in collection
        if (this.collection.indexOf(comic) == -1) {

          // Push into collection
          this.collection.push(comic);

          // Modify and show toast (notification)
          toast_element = document.getElementById('success');
          toast_element.text = 'Added '+ comic.name +' to your collection !';
          toast_element.show();

          // Set clear icon to e.target paper-fab
          e.target.setAttribute('icon', 'clear');

        }  
        else {

          // If this object is in collection
          if (this.collection.indexOf(comic) > -1) {

            // Remove from collection
            this.collection.splice(this.collection.indexOf(comic));

            // Modify and show toast (notification)
            toast_element = document.getElementById('success');
            toast_element.text = 'Deleted '+ comic.name +' from your collection';
            toast_element.show();

            // Set add icon to e.target paper-fab
            e.target.setAttribute('icon', 'add');
          }
          else {
            toast_element = document.getElementById('error');
            toast_element.text = 'You haven\'t '+ comic.name +' in your collection...';
            toast_element.show();
          }

        }
      },
      addToWishlist: function(e, detail, sender) {
        var comic = e.target.templateInstance.model.r;

        // If this object is not in wishlist
        if (this.wishlist.indexOf(comic) == -1) {
          
          // Push into wishlist 
          this.wishlist.push(comic);

          // Modify and show toast (notification)
          toast_element = document.getElementById('success');
          toast_element.text = 'Added '+ comic.name +' to your wishlist !';
          toast_element.show();

          // Change icon color
          e.target.setAttribute("class", "active")
        }
        else {

          // If this object is in wishlist
          if (this.wishlist.indexOf(comic) > -1) {

            // Remove from wishlist
            this.wishlist.splice(this.wishlist.indexOf(comic));

            // Modify and show toast (notification)
            toast_element = document.getElementById('success');
            toast_element.text = 'Deleted '+ comic.name +' from your wishlist';
            toast_element.show();

            // Change icon color
            e.target.setAttribute("class", "inactive")
          }
          else {
            toast_element = document.getElementById('error');
            toast_element.text = 'You haven\'t '+ comic.name +' in your wishlist...';
            toast_element.show();
          }
        }
      }
    });
  })();

  </script>
</polymer-element>
